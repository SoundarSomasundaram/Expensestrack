<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1a1a2e;
            --color-green: #00d4aa;
            --color-accent: #ff6b6b;
            --color-delete: #ff4757;
            --color-blue: #4ecdc4;
            --color-purple: #a55eea;
            --color-orange: #fd79a8;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            color: rgba(26, 26, 46, 0.8);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            pointer-events: none;
            z-index: -1;
        }

        .App {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            gap: 2rem;
            min-height: 100vh;
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .Navigation {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 2rem;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .Navigation::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-secondary);
        }

        .user-con {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .user-con img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: var(--shadow-light);
        }

        .menu-items {
            list-style: none;
        }

        .menu-items li {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            overflow: hidden;
        }

        .menu-items li::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .menu-items li:hover::before {
            left: 100%;
        }

        .menu-items li:hover {
            background: rgba(255, 107, 107, 0.1);
            transform: translateX(5px);
        }

        .menu-items li.active {
            background: var(--gradient-secondary);
            color: white;
            box-shadow: var(--shadow-light);
            transform: scale(1.02);
        }

        main {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 2rem;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        main::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-success);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: var(--shadow-light);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-success);
        }

        .stat-card h3 {
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .stat-card .amount {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-success);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-container {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-secondary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .btn {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .transaction-list {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e1e5e9;
            transition: background 0.3s ease;
        }

        .transaction-item:hover {
            background: #f8f9fa;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: white;
            font-size: 1.2rem;
        }

        .transaction-icon.income {
            background: var(--color-green);
        }

        .transaction-icon.expense {
            background: var(--color-accent);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .transaction-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .transaction-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .transaction-amount.income {
            color: var(--color-green);
        }

        .transaction-amount.expense {
            color: var(--color-accent);
        }

        .delete-btn {
            background: var(--color-delete);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 1rem;
        }

        .delete-btn:hover {
            background: #dc3545;
        }

        .hidden {
            display: none;
        }

        /* Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .chatbot-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-secondary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            box-shadow: var(--shadow-medium);
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
        }

        .chatbot-toggle .notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .chatbot-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 25px;
            box-shadow: var(--shadow-heavy);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideIn 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chatbot-window.active {
            display: flex;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .chatbot-container {
                bottom: 1rem;
                right: 1rem;
            }

            .chatbot-window {
                width: calc(100vw - 2rem);
                height: 60vh;
                right: 0;
                bottom: 80px;
            }

            .chatbot-toggle {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }

        .chatbot-header {
            background: var(--gradient-secondary);
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .chatbot-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
        }

        .chatbot-header h3 {
            margin: 0;
            color: white;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .chatbot-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 0.8rem;
            border-radius: 15px;
            word-wrap: break-word;
            margin-bottom: 0.5rem;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: var(--gradient-secondary);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            box-shadow: var(--shadow-light);
        }

        .message.bot {
            background: #f1f3f4;
            color: var(--primary-color);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.loading {
            background: #f1f3f4;
            color: var(--primary-color);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .message .timestamp {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.3rem;
        }

        .quick-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }

        .quick-action-btn {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            white-space: nowrap;
            box-shadow: var(--shadow-light);
        }

        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .chatbot-input {
            padding: 1rem;
            border-top: 1px solid #e1e5e9;
            display: flex;
            gap: 0.5rem;
        }

        .chatbot-input input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid #e1e5e9;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .chatbot-input input:focus {
            outline: none;
            border-color: var(--color-accent);
        }

        .chatbot-send {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 50%;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
        }

        .chatbot-send:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-medium);
        }

        .chatbot-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-top: 2px solid var(--color-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .insight-card {
            background: var(--gradient-primary);
            color: white;
            padding: 1.5rem;
            border-radius: 20px;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-success);
        }

        .insight-card h4 {
            color: white;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="App">
        <nav class="Navigation">
            <div class="user-con">
                <img src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='40' fill='%23F56692'/><circle cx='35' cy='40' r='5' fill='white'/><circle cx='65' cy='40' r='5' fill='white'/><path d='M 30 60 Q 50 70 70 60' stroke='white' stroke-width='3' fill='none'/></svg>" alt="Avatar">
                <div>
                    <h3>Mike</h3>
                    <p>Your Money</p>
                </div>
            </div>
            <ul class="menu-items">
                <li class="active" data-tab="dashboard">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Dashboard</span>
                </li>
                <li data-tab="income">
                    <i class="fa-solid fa-money-bill-trend-up"></i>
                    <span>Incomes</span>
                </li>
                <li data-tab="expenses">
                    <i class="fa-solid fa-money-bill-transfer"></i>
                    <span>Expenses</span>
                </li>
                <li data-tab="chatbot">
                    <i class="fa-solid fa-robot"></i>
                    <span>AI Assistant</span>
                </li>
            </ul>
        </nav>

        <main>
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h1>Dashboard</h1>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Income</h3>
                        <div class="amount" id="total-income">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Expenses</h3>
                        <div class="amount" id="total-expenses">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Balance</h3>
                        <div class="amount" id="balance">$0.00</div>
                    </div>
                </div>
                <div class="transaction-list">
                    <h3 style="padding: 1rem; margin: 0; border-bottom: 1px solid #e1e5e9;">Recent Transactions</h3>
                    <div id="recent-transactions"></div>
                </div>
            </div>

            <!-- Income Tab -->
            <div id="income" class="tab-content">
                <h1>Add Income</h1>
                <div class="form-container">
                    <form id="income-form">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" name="title" placeholder="Salary, Freelance, etc." required>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" name="amount" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select name="category" required>
                                <option value="">Select Category</option>
                                <option value="salary">Salary</option>
                                <option value="freelancing">Freelancing</option>
                                <option value="investments">Investments</option>
                                <option value="stocks">Stocks</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="description" rows="3" placeholder="Optional description"></textarea>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fa-solid fa-plus"></i> Add Income
                        </button>
                    </form>
                </div>
                <div class="transaction-list">
                    <h3 style="padding: 1rem; margin: 0; border-bottom: 1px solid #e1e5e9;">Income History</h3>
                    <div id="income-list"></div>
                </div>
            </div>

            <!-- Expenses Tab -->
            <div id="expenses" class="tab-content">
                <h1>Add Expense</h1>
                <div class="form-container">
                    <form id="expense-form">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" name="title" placeholder="Food, Rent, etc." required>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" name="amount" placeholder="0.00" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select name="category" required>
                                <option value="">Select Category</option>
                                <option value="food">Food</option>
                                <option value="rent">Rent</option>
                                <option value="transportation">Transportation</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="utilities">Utilities</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea name="description" rows="3" placeholder="Optional description"></textarea>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fa-solid fa-plus"></i> Add Expense
                        </button>
                    </form>
                </div>
                <div class="transaction-list">
                    <h3 style="padding: 1rem; margin: 0; border-bottom: 1px solid #e1e5e9;">Expense History</h3>
                    <div id="expense-list"></div>
                </div>
            </div>

            <!-- Chatbot Tab -->
            <div id="chatbot" class="tab-content">
                <h1>AI Financial Assistant</h1>
                <div class="insight-card">
                    <h4>ðŸ¤– Your Personal Finance AI</h4>
                    <p>Ask me anything about your expenses, income, spending patterns, or get financial advice!</p>
                </div>
                
                <div class="chatbot-container">
                    <div class="chatbot-window" id="chatbot-window">
                        <div class="chatbot-header">
                            <h3><i class="fa-solid fa-robot"></i> Finance AI</h3>
                            <button class="chatbot-close" onclick="toggleChatbot()">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                                                 <div class="chatbot-messages" id="chatbot-messages">
                             <div class="message bot">
                                 ðŸ‘‹ Hello! I'm your AI financial assistant. I can help you analyze your expenses, track spending patterns, and provide financial insights. What would you like to know?
                             </div>
                             <div class="quick-actions">
                                 <button class="quick-action-btn" onclick="sendQuickMessage('What is my current balance?')">ðŸ’° Balance</button>
                                 <button class="quick-action-btn" onclick="sendQuickMessage('Show my spending patterns')">ðŸ“Š Spending</button>
                                 <button class="quick-action-btn" onclick="sendQuickMessage('Give me financial advice')">ðŸ’¡ Advice</button>
                             </div>
                         </div>
                        <div class="chatbot-input">
                            <input type="text" id="chatbot-input" placeholder="Ask about your finances..." onkeypress="handleChatbotKeyPress(event)">
                            <button class="chatbot-send" onclick="sendMessage()" id="chatbot-send">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    <button class="chatbot-toggle" onclick="toggleChatbot()">
                        <i class="fa-solid fa-robot"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global state
        let incomes = [];
        let expenses = [];
        let isChatbotOpen = false;

        // Gemini API Configuration
        const GEMINI_API_KEY = 'AIzaSyCHsrk6n80HgF6O1hWRKNHYx6GvvUI40GU';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';

        // API Configuration
        const API_BASE_URL = 'http://localhost:5000/api/v1';

        // Load data from localStorage only
        async function loadData() {
            // Load data from localStorage
            const savedIncomes = localStorage.getItem('incomes');
            const savedExpenses = localStorage.getItem('expenses');
            
            if (savedIncomes) incomes = JSON.parse(savedIncomes);
            if (savedExpenses) expenses = JSON.parse(savedExpenses);
            
            console.log('Loaded data from localStorage:', { incomes: incomes.length, expenses: expenses.length });
        }

        // Save data to localStorage
        function saveToLocalStorage() {
            localStorage.setItem('incomes', JSON.stringify(incomes));
            localStorage.setItem('expenses', JSON.stringify(expenses));
        }

        // Save data to API (kept for compatibility)
        async function saveData() {
            saveToLocalStorage();
        }

        // Calculate totals
        function calculateTotals() {
            const totalIncome = incomes.reduce((sum, item) => sum + parseFloat(item.amount), 0);
            const totalExpenses = expenses.reduce((sum, item) => sum + parseFloat(item.amount), 0);
            const balance = totalIncome - totalExpenses;

            document.getElementById('total-income').textContent = `â‚¹${totalIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('total-expenses').textContent = `â‚¹${totalExpenses.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('balance').textContent = `â‚¹${balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        // Get category icon
        function getCategoryIcon(category) {
            const icons = {
                salary: 'fa-briefcase',
                freelancing: 'fa-laptop',
                investments: 'fa-chart-line',
                stocks: 'fa-chart-line',
                food: 'fa-utensils',
                rent: 'fa-home',
                transportation: 'fa-car',
                entertainment: 'fa-tv',
                utilities: 'fa-bolt',
                other: 'fa-ellipsis'
            };
            return icons[category] || 'fa-tag';
        }

        // Render transaction list
        function renderTransactionList(transactions, containerId, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (transactions.length === 0) {
                container.innerHTML = '<p style="padding: 1rem; text-align: center; color: #6c757d;">No transactions yet</p>';
                return;
            }

            transactions.forEach(transaction => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = `
                    <div class="transaction-icon ${type}">
                        <i class="fa-solid ${getCategoryIcon(transaction.category)}"></i>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-title">${transaction.title}</div>
                        <div class="transaction-meta">
                            ${new Date(transaction.date).toLocaleDateString()} â€¢ ${transaction.category}
                            ${transaction.description ? ` â€¢ ${transaction.description}` : ''}
                        </div>
                    </div>
                                         <div class="transaction-amount ${type}">â‚¹${parseFloat(transaction.amount).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <button class="delete-btn" onclick="deleteTransaction('${transaction._id || transaction.id}', '${type}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                container.appendChild(item);
            });
        }

        // Render recent transactions
        function renderRecentTransactions() {
            const allTransactions = [
                ...incomes.map(item => ({...item, type: 'income'})),
                ...expenses.map(item => ({...item, type: 'expense'}))
            ];
            
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recent = allTransactions.slice(0, 5);

            const container = document.getElementById('recent-transactions');
            container.innerHTML = '';

            if (recent.length === 0) {
                container.innerHTML = '<p style="padding: 1rem; text-align: center; color: #6c757d;">No transactions yet</p>';
                return;
            }

            recent.forEach(transaction => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = `
                    <div class="transaction-icon ${transaction.type}">
                        <i class="fa-solid ${getCategoryIcon(transaction.category)}"></i>
                    </div>
                    <div class="transaction-details">
                        <div class="transaction-title">${transaction.title}</div>
                        <div class="transaction-meta">
                            ${new Date(transaction.date).toLocaleDateString()} â€¢ ${transaction.category}
                        </div>
                    </div>
                                         <div class="transaction-amount ${transaction.type}">â‚¹${parseFloat(transaction.amount).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                `;
                container.appendChild(item);
            });
        }

        // Add transaction
        async function addTransaction(formData, type) {
            const transaction = {
                id: Date.now().toString(),
                title: formData.get('title'),
                amount: formData.get('amount'),
                date: formData.get('date'),
                category: formData.get('category'),
                description: formData.get('description')
            };

            // Add to local storage
            if (type === 'income') {
                incomes.push(transaction);
            } else {
                expenses.push(transaction);
            }
            saveToLocalStorage();
            updateUI();
        }

        // Delete transaction
        async function deleteTransaction(id, type) {
            // Delete from local storage
            if (type === 'income') {
                incomes = incomes.filter(item => item._id !== id && item.id !== id);
            } else {
                expenses = expenses.filter(item => item._id !== id && item.id !== id);
            }
            saveToLocalStorage();
            updateUI();
        }

        // Update UI
        function updateUI() {
            calculateTotals();
            renderTransactionList(incomes, 'income-list', 'income');
            renderTransactionList(expenses, 'expense-list', 'expense');
            renderRecentTransactions();
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from menu items
            document.querySelectorAll('.menu-items li').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');

            // Add active class to menu item
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        }

        // Chatbot Functions
        function toggleChatbot() {
            const chatbotWindow = document.getElementById('chatbot-window');
            isChatbotOpen = !isChatbotOpen;
            
            if (isChatbotOpen) {
                chatbotWindow.classList.add('active');
            } else {
                chatbotWindow.classList.remove('active');
            }
        }

        function handleChatbotKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendQuickMessage(message) {
            document.getElementById('chatbot-input').value = message;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            input.value = '';

            // Show loading message
            const loadingId = addLoadingMessage();

            try {
                // Prepare financial data for AI
                const financialData = prepareFinancialData();
                
                // Generate AI response
                const response = await generateAIResponse(message, financialData);
                
                // Remove loading message and add AI response
                removeLoadingMessage(loadingId);
                addMessage(response, 'bot');
            } catch (error) {
                console.error('Error generating AI response:', error);
                removeLoadingMessage(loadingId);
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
            }
        }

        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatbot-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            // Add timestamp
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div>${text}</div>
                <div class="timestamp">${timestamp}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addLoadingMessage() {
            const messagesContainer = document.getElementById('chatbot-messages');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message loading';
            loadingDiv.innerHTML = '<div class="spinner"></div> AI is thinking...';
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return loadingId;
        }

        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        function prepareFinancialData() {
            const totalIncome = incomes.reduce((sum, item) => sum + parseFloat(item.amount), 0);
            const totalExpenses = expenses.reduce((sum, item) => sum + parseFloat(item.amount), 0);
            const balance = totalIncome - totalExpenses;

            // Group expenses by category
            const expensesByCategory = {};
            expenses.forEach(expense => {
                if (!expensesByCategory[expense.category]) {
                    expensesByCategory[expense.category] = 0;
                }
                expensesByCategory[expense.category] += parseFloat(expense.amount);
            });

            // Group incomes by category
            const incomesByCategory = {};
            incomes.forEach(income => {
                if (!incomesByCategory[income.category]) {
                    incomesByCategory[income.category] = 0;
                }
                incomesByCategory[income.category] += parseFloat(income.amount);
            });

            return {
                totalIncome,
                totalExpenses,
                balance,
                expensesByCategory,
                incomesByCategory,
                recentTransactions: [...incomes, ...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10),
                totalTransactions: incomes.length + expenses.length
            };
        }

        async function generateAIResponse(userMessage, financialData) {
            // Enhanced prompt with more context and better formatting
            const prompt = `You are a helpful financial AI assistant named "FinanceBot". The user has the following financial data in Indian Rupees (â‚¹):

ðŸ“Š FINANCIAL SUMMARY:
â€¢ Total Income: â‚¹${financialData.totalIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
â€¢ Total Expenses: â‚¹${financialData.totalExpenses.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
â€¢ Balance: â‚¹${financialData.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
â€¢ Total Transactions: ${financialData.totalTransactions}

ðŸ’° EXPENSES BY CATEGORY:
${Object.entries(financialData.expensesByCategory).map(([category, amount]) => `â€¢ ${category.charAt(0).toUpperCase() + category.slice(1)}: â‚¹${amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`).join('\n')}

ðŸ’µ INCOMES BY CATEGORY:
${Object.entries(financialData.incomesByCategory).map(([category, amount]) => `â€¢ ${category.charAt(0).toUpperCase() + category.slice(1)}: â‚¹${amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`).join('\n')}

ðŸ“ RECENT TRANSACTIONS (last 10):
${financialData.recentTransactions.map(t => `â€¢ ${t.title}: â‚¹${parseFloat(t.amount).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${t.category}) on ${new Date(t.date).toLocaleDateString()}`).join('\n')}

User Question: "${userMessage}"

Please provide a helpful, friendly response with financial insights, advice, or analysis based on their data. Be concise but informative. Use emojis and bullet points to make your response more engaging. If they ask about spending patterns, suggest ways to save money, or request financial advice, provide actionable insights. Keep your response under 200 words.`;

            try {
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate AI response');
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                // Fallback response if AI fails
                return generateFallbackResponse(userMessage, financialData);
            }
        }

        function generateFallbackResponse(userMessage, financialData) {
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('balance') || lowerMessage.includes('total')) {
                return `ðŸ’° Your current balance is â‚¹${financialData.balance.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}.\n\nðŸ“Š Breakdown:\nâ€¢ Total Income: â‚¹${financialData.totalIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\nâ€¢ Total Expenses: â‚¹${financialData.totalExpenses.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\n\n${financialData.balance >= 0 ? 'âœ… You\'re in a positive financial position!' : 'âš ï¸ You\'re currently spending more than you earn.'}`;
            }
            
            if (lowerMessage.includes('expense') || lowerMessage.includes('spending')) {
                const topExpense = Object.entries(financialData.expensesByCategory)
                    .sort(([,a], [,b]) => b - a)[0];
                
                return `ðŸ“ˆ Your total expenses are â‚¹${financialData.totalExpenses.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}.\n\nðŸ† Highest spending category: ${topExpense ? topExpense[0] : 'None'} (â‚¹${topExpense ? topExpense[1].toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'})\n\nðŸ’¡ Tip: Consider reviewing your ${topExpense ? topExpense[0] : 'expense'} category for potential savings!`;
            }
            
            if (lowerMessage.includes('income') || lowerMessage.includes('earn')) {
                return `ðŸ’µ Your total income is â‚¹${financialData.totalIncome.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}.\n\nðŸ“Š Income sources:\n${Object.entries(financialData.incomesByCategory).map(([category, amount]) => `â€¢ ${category}: â‚¹${amount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`).join('\n')}\n\nðŸŽ¯ Great job on diversifying your income sources!`;
            }
            
            return `ðŸ¤– Hi! I'm here to help with your finances. You have ${financialData.totalTransactions} transactions recorded.\n\nðŸ’¡ Try asking me about:\nâ€¢ Your current balance\nâ€¢ Spending patterns\nâ€¢ Income analysis\nâ€¢ Financial advice\n\nI'm analyzing your data to provide personalized insights!`;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            await loadData();
            updateUI();

            // Navigation
            document.querySelectorAll('.menu-items li').forEach(item => {
                item.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // Income form
            document.getElementById('income-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                await addTransaction(formData, 'income');
                this.reset();
            });

            // Expense form
            document.getElementById('expense-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                await addTransaction(formData, 'expense');
                this.reset();
            });
        });
    </script>
</body>
</html>
